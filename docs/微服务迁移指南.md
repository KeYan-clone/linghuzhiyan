# 灵狐智验微服务架构详细分析报告

## 项目概述

"灵狐智验"是一个基于Spring Cloud微服务架构的教学实验管理系统，从单体应用重构为微服务架构，提供了完整的教学实验管理、用户管理、讨论交流、资源管理等功能。

## 整体架构设计

### 系统层次结构
```
┌─────────────────────────────────────────────────────────────┐
│                      接入层                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │   前端应用   │  │  移动应用    │  │  第三方集成  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    网关层                                    │
│            linghuzhiyan-gateway (8080)                     │
│    ┌───────────────────────────────────────────────────┐    │
│    │ 路由 │ 负载均衡 │ 认证 │ 限流 │ 监控 │ 跨域处理      │    │
│    └───────────────────────────────────────────────────┘    │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   基础设施层                                  │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │服务发现中心  │  │   配置中心   │  │   监控服务   │          │
│  │Eureka(8761) │  │Config(8888) │  │Admin(8090)  │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    业务服务层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  认证服务    │  │  用户服务    │  │  实验服务    │          │
│  │ Auth(8081)  │  │ User(8082)  │  │Exp.(8083)   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │  讨论服务    │  │  消息服务    │  │  资源服务    │          │
│  │Disc.(8084)  │  │ Msg.(8085)  │  │Res.(8086)   │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                    数据存储层                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐          │
│  │    MySQL    │  │   MongoDB   │  │    MinIO    │          │
│  │  关系数据    │  │  文档数据    │  │  对象存储    │          │
│  └─────────────┘  └─────────────┘  └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
```

## 微服务详细分析

### 1. 基础设施服务

#### 1.1 服务发现服务 (linghuzhiyan-discovery-server)
- **端口**: 8761
- **技术栈**: Spring Cloud Netflix Eureka
- **核心职责**:
  - 微服务注册与发现
  - 服务健康检查
  - 服务实例管理
  - 负载均衡支持
- **关键配置**:
  - 服务自保护机制
  - 心跳检测间隔
  - 实例清理策略
- **访问地址**: http://localhost:8761

#### 1.2 配置中心服务 (linghuzhiyan-config-server)
- **端口**: 8888
- **技术栈**: Spring Cloud Config
- **核心职责**:
  - 集中配置管理
  - 多环境配置支持
  - 配置动态刷新
  - 配置版本控制
- **配置文件管理**:
  ```
  config-repo/
  ├── auth-service.yml          # 认证服务配置
  ├── user-service.yml          # 用户服务配置
  ├── experiment-service.yml    # 实验服务配置
  ├── discussion-service.yml    # 讨论服务配置
  ├── message-service.yml       # 消息服务配置
  ├── resource-service.yml      # 资源服务配置
  ├── gateway.yml              # 网关服务配置
  └── monitor-service.yml      # 监控服务配置
  ```

#### 1.3 API网关服务 (linghuzhiyan-gateway)
- **端口**: 8080
- **技术栈**: Spring Cloud Gateway
- **核心职责**:
  - 统一API入口
  - 请求路由与负载均衡
  - JWT令牌验证
  - 跨域(CORS)处理
  - 请求限流与熔断
  - 请求/响应日志
- **主要组件**:
  - GlobalFilter: 全局过滤器
  - RouteFilter: 路由过滤器
  - FallbackController: 熔断回退控制器
- **路由配置**:
  ```yaml
  spring:
    cloud:
      gateway:
        routes:
          - id: auth-service
            uri: lb://linghuzhiyan-auth-service
            predicates:
              - Path=/api/auth/**,/api/users/login,/api/users/logout
          - id: user-service
            uri: lb://linghuzhiyan-user-service
            predicates:
              - Path=/api/users/**
  ```

#### 1.4 监控服务 (linghuzhiyan-monitor-service)
- **端口**: 8090
- **技术栈**: Spring Boot Admin
- **核心职责**:
  - 微服务健康状态监控
  - 性能指标收集与展示
  - JVM运行状态监控
  - 异常告警通知
  - 日志聚合分析
- **监控功能**:
  - 实时服务状态
  - 内存使用情况
  - 线程池状态
  - HTTP请求统计
  - 数据库连接池监控
- **访问地址**: http://localhost:8090 (admin/admin123)

### 2. 业务服务

#### 2.1 认证服务 (linghuzhiyan-auth-service)
- **端口**: 8081
- **技术栈**: Spring Security + JWT
- **核心职责**:
  - 用户身份认证
  - JWT令牌生成与验证
  - 角色权限管理
  - 登录日志记录
- **主要实体**:
  ```java
  Role.java                 // 角色定义
  UserRoleRelation.java     // 用户角色关联
  LoginLog.java            // 登录日志
  ```
- **核心API**:
  - `POST /api/users/login` - 用户登录
  - `POST /api/users/logout` - 用户登出
  - `POST /api/auth/refresh` - 刷新令牌
  - `POST /api/auth/validate` - 验证令牌
- **安全机制**:
  - JWT令牌机制
  - 密码加密存储
  - 登录失败锁定
  - 多角色权限控制

#### 2.2 用户服务 (linghuzhiyan-user-service)
- **端口**: 8082
- **技术栈**: Spring Boot + JPA + MySQL
- **核心职责**:
  - 用户信息管理
  - 用户注册与资料维护
  - 角色权限分配
  - 头像上传管理
- **主要实体**:
  ```java
  User.java               // 用户基本信息
  ```
- **核心API**:
  - `POST /api/users/register` - 用户注册
  - `GET /api/users/profile` - 获取个人资料
  - `PUT /api/users/profile` - 更新个人资料
  - `PUT /api/users/password` - 修改密码
  - `POST /api/users/avatar` - 上传头像
  - `POST /api/users/setrole` - 设置用户角色
- **权限控制**:
  - ADMIN: 系统管理员
  - TEACHER: 教师
  - ASSISTANT: 助教
  - STUDENT: 学生

#### 2.3 实验服务 (linghuzhiyan-experiment-service)
- **端口**: 8083
- **技术栈**: Spring Boot + JPA + MySQL
- **核心职责**:
  - 实验课程与项目管理
  - 实验任务创建与分配
  - 学生实验提交管理
  - 实验评价与成绩管理
  - 题库管理
- **主要实体**:
  ```java
  Experiment.java           // 实验课程/项目
  ExperimentTask.java      // 实验任务
  ExperimentAssignment.java // 实验作业分配
  ExperimentSubmission.java // 实验提交记录
  Question.java            // 题库题目
  ```
- **核心API**:
  - `POST /api/experiments` - 创建实验
  - `GET /api/experiments` - 查询实验列表
  - `POST /api/questions` - 创建题目
  - `GET /api/questions` - 查询题目
  - `POST /api/tasks` - 创建实验任务
  - `POST /api/assignments` - 分配实验作业
- **业务流程**:
  1. 教师创建实验课程
  2. 创建实验任务
  3. 分配给学生
  4. 学生提交实验
  5. 教师评价打分

#### 2.4 讨论服务 (linghuzhiyan-discussion-service)
- **端口**: 8084
- **技术栈**: Spring Boot + MongoDB
- **核心职责**:
  - 实验讨论主题管理
  - 评论与回复功能
  - 问答模块
  - 内容审核与管理
- **主要实体**:
  ```java
  Discussion.java          // 讨论主题
  Comment.java            // 评论内容
  Question.java           // 问题
  Attachment.java         // 附件
  RichContent.java        // 富文本内容
  ```
- **核心API**:
  - `POST /api/discussions` - 创建讨论
  - `GET /api/discussions` - 查询讨论列表
  - `POST /api/comments` - 发表评论
  - `GET /api/comments` - 查询评论
  - `PUT /api/discussions/{id}/priority` - 设置优先级
- **特色功能**:
  - 富文本编辑器支持
  - 附件上传
  - 讨论优先级管理
  - 内容审核机制

#### 2.5 消息服务 (linghuzhiyan-message-service)
- **端口**: 8085
- **技术栈**: Spring Boot + JPA + MySQL
- **核心职责**:
  - 系统通知管理
  - 用户私信功能
  - 公告发布与管理
  - 消息状态跟踪
- **主要实体**:
  ```java
  Message.java            // 消息实体
  Announcement.java       // 公告实体
  ```
- **核心API**:
  - `POST /api/messages` - 创建消息
  - `GET /api/messages/receiver` - 获取接收消息
  - `POST /api/announcements` - 发布公告
  - `GET /api/announcements` - 查询公告
  - `PUT /api/messages/{id}/read` - 标记已读
- **消息类型**:
  - 系统通知
  - 实验提醒
  - 成绩通知
  - 讨论回复通知

#### 2.6 资源服务 (linghuzhiyan-resource-service)
- **端口**: 8086
- **技术栈**: Spring Boot + JPA + MinIO
- **核心职责**:
  - 教学资源存储与管理
  - 文件上传与下载
  - 实验资料管理
  - 学生作业文件管理
- **主要实体**:
  ```java
  Resource.java           // 教学资源
  Attachment.java         // 文件附件
  RichContent.java        // 富文本内容
  ```
- **核心API**:
  - `POST /api/resources/upload` - 上传资源
  - `GET /api/resources` - 查询资源列表
  - `GET /api/resources/experiments/{expId}` - 获取实验资源
  - `GET /api/resources/{id}/download` - 下载资源
  - `DELETE /api/resources/{id}` - 删除资源
- **存储策略**:
  - 使用MinIO对象存储
  - 支持文件分类管理
  - 自动文件类型检测
  - 文件访问权限控制

### 3. 通用组件

#### 3.1 公共模块 (linghuzhiyan-common)
- **核心职责**:
  - 提供共享的DTO对象
  - 统一异常处理机制
  - 通用工具类库
  - 公共配置类
  - Feign客户端定义
- **主要组件**:
  ```
  dto/                    # 数据传输对象
  ├── ApiResponse.java    # 统一响应格式
  ├── UserDTO.java        # 用户DTO
  ├── ExperimentDTO.java  # 实验DTO
  └── ...
  
  exception/              # 异常处理
  ├── GlobalExceptionHandler.java  # 全局异常处理器
  ├── BusinessException.java       # 业务异常
  └── ServiceException.java        # 服务异常
  
  feign/                  # 服务间调用
  ├── client/
  │   ├── UserServiceClient.java
  │   └── ExperimentServiceClient.java
  └── config/
      └── FeignClientConfig.java
  
  utils/                  # 工具类
  ├── JsonUtils.java      # JSON工具
  ├── MinioUtil.java      # MinIO工具
  └── RequestUtils.java   # 请求工具
  ```

## 单体应用向微服务架构迁移指南

### 迁移原则和策略

在将单体应用改造为微服务架构时，应遵循"**先基础设施，后业务服务**"和"**逐步分离，平滑过渡**"的原则。

### 📋 迁移顺序详解

#### 阶段一：基础设施搭建 (Foundation Phase)

**目标**: 建立微服务运行的基础环境，确保服务能够被发现、配置和监控

##### 1️⃣ 服务发现中心 (`linghuzhiyan-discovery-server`)
```bash
优先级: 🔥 最高
依赖关系: 无
迁移理由: 所有微服务都需要注册到服务发现中心
```

**迁移步骤**:
- 创建独立的Eureka Server项目
- 配置服务注册中心
- 验证服务注册功能
- 确保高可用配置

**验证标准**:
- Eureka控制台可访问 (http://localhost:8761)
- 服务注册机制正常工作

##### 2️⃣ 配置中心 (`linghuzhiyan-config-server`)
```bash
优先级: 🔥 最高
依赖关系: 依赖服务发现中心
迁移理由: 统一管理所有微服务配置，避免配置分散
```

**迁移步骤**:
- 建立配置中心服务
- 提取单体应用中的配置文件
- 按服务划分配置文件
- 配置Git仓库存储(可选)

**验证标准**:
- 配置中心注册到Eureka
- 各服务配置文件可正常获取

##### 3️⃣ API网关 (`linghuzhiyan-gateway`)
```bash
优先级: 🔥 高
依赖关系: 依赖服务发现中心和配置中心
迁移理由: 统一入口，简化客户端调用
```

**迁移步骤**:
- 搭建Spring Cloud Gateway
- 配置路由规则
- 实现认证过滤器
- 配置跨域和限流

**验证标准**:
- 网关正常启动并注册
- 路由转发功能正常

##### 4️⃣ 监控服务 (`linghuzhiyan-monitor-service`)
```bash
优先级: 🟡 中等
依赖关系: 依赖服务发现中心
迁移理由: 及时发现服务问题，保障系统稳定性
```

**迁移步骤**:
- 部署Spring Boot Admin
- 配置监控端点
- 设置告警规则
- 集成日志收集

#### 阶段二：核心业务服务分离 (Core Services Phase)

**目标**: 分离核心业务功能，确保系统核心能力不受影响

##### 5️⃣ 认证服务 (`linghuzhiyan-auth-service`)
```bash
优先级: 🔥 最高
依赖关系: 依赖基础设施服务
迁移理由: 安全是微服务架构的基础，必须优先保障
```

**迁移步骤**:
1. **数据库分离**:
   ```sql
   -- 创建独立的认证数据库
   CREATE DATABASE linghu_auth;
   -- 迁移用户认证相关表
   - users (认证信息)
   - roles (角色表)
   - user_role_relations (用户角色关联)
   - login_logs (登录日志)
   ```

2. **服务抽取**:
   - 提取JWT工具类
   - 实现认证控制器
   - 配置Spring Security
   - 实现登录/登出接口

3. **网关集成**:
   - 在网关配置JWT验证
   - 实现统一认证拦截
   - 配置权限路由规则

**验证标准**:
- 用户登录功能正常
- JWT令牌生成和验证正常
- 网关认证拦截生效

##### 6️⃣ 用户服务 (`linghuzhiyan-user-service`)
```bash
优先级: 🔥 高
依赖关系: 与认证服务协作
迁移理由: 用户管理是系统的核心功能
```

**迁移步骤**:
1. **数据库分离**:
   ```sql
   -- 创建用户服务数据库
   CREATE DATABASE linghu_user;
   -- 迁移用户信息相关表
   - user_profiles (用户资料)
   - user_settings (用户设置)
   ```

2. **服务实现**:
   - 用户CRUD操作
   - 头像上传功能
   - 角色管理功能
   - Feign客户端调用认证服务

**验证标准**:
- 用户注册功能正常
- 用户信息管理功能正常
- 与认证服务集成正常

#### 阶段三：业务功能服务化 (Business Services Phase)

**目标**: 按业务领域拆分剩余功能模块

##### 7️⃣ 实验服务 (`linghuzhiyan-experiment-service`)
```bash
优先级: 🔥 最高
依赖关系: 依赖用户服务
迁移理由: 核心业务功能，实验管理是系统主要价值
```

**迁移步骤**:
1. **数据库设计**:
   ```sql
   CREATE DATABASE linghu_experiment;
   -- 核心实验表
   - experiments (实验项目)
   - experiment_tasks (实验任务)
   - experiment_assignments (作业分配)
   - experiment_submissions (提交记录)
   - questions (题库)
   ```

2. **业务逻辑迁移**:
   - 实验管理功能
   - 任务分配逻辑
   - 提交评分系统
   - 题库管理

**验证标准**:
- 实验创建和管理功能正常
- 学生提交和教师评分流程正常

##### 8️⃣ 资源服务 (`linghuzhiyan-resource-service`)
```bash
优先级: 🟡 中等
依赖关系: 为实验服务提供支持
迁移理由: 文件管理独立性强，适合单独服务
```

**迁移步骤**:
1. **存储架构调整**:
   - 部署MinIO对象存储
   - 配置文件上传接口
   - 实现权限控制

2. **服务集成**:
   - 与实验服务集成
   - 提供文件上传下载API

##### 9️⃣ 消息服务 (`linghuzhiyan-message-service`)
```bash
优先级: 🟡 中等
依赖关系: 依赖用户服务
迁移理由: 通知功能相对独立
```

**迁移步骤**:
1. **数据库分离**:
   ```sql
   CREATE DATABASE linghu_message;
   - messages (消息表)
   - announcements (公告表)
   ```

2. **功能实现**:
   - 消息推送机制
   - 公告管理
   - 消息状态跟踪

##### 🔟 讨论服务 (`linghuzhiyan-discussion-service`)
```bash
优先级: 🟢 低
依赖关系: 依赖用户服务和实验服务
迁移理由: 社交功能，可最后迁移
```

**迁移步骤**:
1. **数据存储选择**:
   - 使用MongoDB存储
   - 设计文档结构
   - 配置索引优化

2. **功能迁移**:
   - 讨论主题管理
   - 评论系统
   - 内容审核机制

### 📅 迁移时间规划

```
阶段一：基础设施搭建 (1-2周)
├── Week 1: 服务发现中心 + 配置中心
└── Week 2: API网关 + 监控服务

阶段二：核心业务服务 (3-4周)  
├── Week 3: 认证服务迁移
└── Week 4: 用户服务迁移

阶段三：业务功能服务化 (4-6周)
├── Week 5: 实验服务 + 资源服务
├── Week 6: 消息服务 + 讨论服务
└── 整体测试和优化
```

### 🔄 迁移策略建议

#### 1. 渐进式迁移 (Strangler Fig Pattern)
```
单体应用 ← → API网关 ← → 微服务
     ↓
  逐步替换各个模块
```

#### 2. 数据库迁移策略
- **阶段1**: 共享数据库，服务分离
- **阶段2**: 数据库拆分，保持数据一致性
- **阶段3**: 完全独立的数据存储

#### 3. 回滚准备
- 保持单体应用可运行状态
- 准备快速回滚机制
- 制定应急预案

### ✅ 迁移检查清单

#### 每个服务迁移完成后检查:
- [ ] 服务能正常启动并注册到Eureka
- [ ] 配置文件从配置中心正确加载
- [ ] 健康检查端点正常响应
- [ ] 日志输出正常
- [ ] 业务功能验证通过
- [ ] 性能测试达标
- [ ] 监控告警配置完成

#### 整体迁移完成后验证:
- [ ] 所有服务间调用正常
- [ ] 分布式事务处理正确
- [ ] 系统整体性能满足要求
- [ ] 故障转移机制有效
- [ ] 扩容缩容功能正常

### 🚨 风险控制措施

1. **技术风险**:
   - 服务间通信延迟
   - 分布式事务复杂性
   - 数据一致性问题

2. **运维风险**:
   - 部署复杂度增加
   - 监控难度提升
   - 故障排查困难

3. **业务风险**:
   - 功能降级可能
   - 用户体验影响
   - 数据丢失风险

**缓解措施**:
- 充分的测试环境验证
- 详细的回滚预案
- 分阶段灰度发布
- 7×24小时监控保障

通过这个有序的迁移过程，可以确保从单体应用到微服务架构的平滑过渡，最大程度降低业务风险，提高迁移成功率。

