# 灵狐智验微服务测试指南

## 概述
本指南将指导您完成微服务架构的完整测试，包括基础设施测试、服务单元测试、集成测试和端到端测试。

## 1. 基础设施测试

### 1.1 启动基础设施服务
```bash
# 在项目根目录执行
./start-infrastructure.bat
```

基础设施包括：
- 服务发现中心 (Eureka): http://localhost:8761
- 配置中心 (Config Server): http://localhost:8888
- API网关 (Gateway): http://localhost:8080
- 监控服务 (Monitor): http://localhost:8090
- 认证服务 (Auth): http://localhost:8081

### 1.2 验证基础设施
```bash
# 验证所有基础服务
./verify-infrastructure.bat
```

### 1.3 手动验证关键服务
- **Eureka控制台**: http://localhost:8761 (admin/admin123)
- **配置中心测试**: http://localhost:8888/application/default
- **网关健康检查**: http://localhost:8080/actuator/health

## 2. 业务服务测试

### 2.1 启动业务服务

#### 用户服务 (User Service)
```bash
cd linghuzhiyan-user-service
mvn spring-boot:run
```
- 端口: 8082
- 健康检查: http://localhost:8082/actuator/health

#### 实验服务 (Experiment Service) 
```bash
cd linghuzhiyan-experiment-service
mvn spring-boot:run
```
- 端口: 8083
- 健康检查: http://localhost:8083/actuator/health

#### 资源服务 (Resource Service)
```bash
cd linghuzhiyan-resource-service
mvn spring-boot:run
```
- 端口: 8084
- 健康检查: http://localhost:8084/actuator/health

#### 消息服务 (Message Service)
```bash
cd linghuzhiyan-message-service
mvn spring-boot:run
```
- 端口: 8085
- 健康检查: http://localhost:8085/actuator/health

#### 讨论服务 (Discussion Service)
```bash
cd linghuzhiyan-discussion-service
mvn spring-boot:run
```
- 端口: 8086
- 健康检查: http://localhost:8086/actuator/health

### 2.2 验证服务注册
访问 Eureka 控制台，确认所有服务都已注册：
- USER-SERVICE
- EXPERIMENT-SERVICE  
- RESOURCE-SERVICE
- MESSAGE-SERVICE
- DISCUSSION-SERVICE

## 3. 单元测试

### 3.1 运行所有服务的单元测试
```bash
# 在项目根目录
mvn clean test
```

### 3.2 单独测试各服务
```bash
# 用户服务测试
cd linghuzhiyan-user-service && mvn test

# 实验服务测试
cd linghuzhiyan-experiment-service && mvn test

# 资源服务测试
cd linghuzhiyan-resource-service && mvn test

# 消息服务测试
cd linghuzhiyan-message-service && mvn test

# 讨论服务测试
cd linghuzhiyan-discussion-service && mvn test
```

## 4. API接口测试

### 4.1 认证测试
```bash
# 用户登录获取token
curl -X POST http://localhost:8080/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "username": "admin",
    "password": "admin123"
  }'
```

### 4.2 用户服务API测试
```bash
# 获取用户信息 (通过网关)
curl -X GET http://localhost:8080/api/user/users/profile \
  -H "Authorization: Bearer YOUR_TOKEN"

# 直接调用用户服务
curl -X GET http://localhost:8082/api/users/profile \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4.3 实验服务API测试
```bash
# 获取实验列表
curl -X GET http://localhost:8080/api/experiment/experiments \
  -H "Authorization: Bearer YOUR_TOKEN"

# 获取学生分配的任务
curl -X GET http://localhost:8080/api/experiment/student/tasks \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4.4 资源服务API测试
```bash
# 上传文件
curl -X POST http://localhost:8080/api/resource/upload \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -F "file=@test.txt"

# 获取资源列表
curl -X GET http://localhost:8080/api/resource/resources \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4.5 消息服务API测试
```bash
# 发送消息
curl -X POST http://localhost:8080/api/message/send \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "receiverId": "user123",
    "content": "测试消息",
    "type": "SYSTEM"
  }'

# 获取消息列表
curl -X GET http://localhost:8080/api/message/messages \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 4.6 讨论服务API测试
```bash
# 创建讨论话题
curl -X POST http://localhost:8080/api/discussion/topics \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "title": "测试话题",
    "content": "测试内容",
    "experimentId": "exp123"
  }'

# 获取讨论列表
curl -X GET http://localhost:8080/api/discussion/topics \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## 5. 服务间通信测试

### 5.1 Feign客户端测试
验证各服务间的Feign客户端调用：

```bash
# 实验服务调用用户服务测试
curl -X GET http://localhost:8083/api/experiments/test-user-client \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 5.2 配置中心测试
```bash
# 获取用户服务配置
curl -u config:config123 http://localhost:8888/user-service/default

# 获取实验服务配置
curl -u config:config123 http://localhost:8888/experiment-service/default
```

## 6. 数据库连接测试

### 6.1 MySQL连接测试
确保以下服务能正常访问MySQL：
- 用户服务
- 实验服务
- 资源服务
- 消息服务

### 6.2 MongoDB连接测试
确保讨论服务能正常访问MongoDB。

## 7. 负载均衡测试

### 7.1 启动多个服务实例
```bash
# 启动第二个用户服务实例
cd linghuzhiyan-user-service
mvn spring-boot:run -Dspring-boot.run.arguments=--server.port=8092
```

### 7.2 验证负载均衡
通过网关多次调用API，观察请求是否分发到不同实例。

## 8. 故障测试

### 8.1 服务下线测试
1. 停止某个服务实例
2. 观察Eureka控制台状态变化
3. 测试其他服务是否正常工作

### 8.2 网络分区测试
1. 停止配置中心
2. 观察服务是否使用本地缓存配置
3. 重启配置中心后验证配置刷新

## 9. 性能测试

### 9.1 使用Apache Bench进行压力测试
```bash
# 测试用户登录接口
ab -n 1000 -c 10 -p login.json -T application/json http://localhost:8080/auth/login

# 测试实验列表接口  
ab -n 1000 -c 10 -H "Authorization: Bearer YOUR_TOKEN" http://localhost:8080/api/experiment/experiments
```

### 9.2 监控服务性能
访问监控服务：http://localhost:8090 (admin/admin123)

## 10. 集成测试场景

### 10.1 完整业务流程测试
1. 用户注册/登录
2. 创建实验
3. 分配实验任务
4. 学生提交作业
5. 教师评分
6. 查看评分结果
7. 参与讨论

### 10.2 跨服务数据一致性测试
1. 在用户服务中更新用户信息
2. 验证实验服务中的用户信息是否通过Feign客户端获取到最新数据

## 11. 日志和监控

### 11.1 检查日志
```bash
# 查看各服务启动日志
tail -f linghuzhiyan-user-service/logs/application.log
tail -f linghuzhiyan-experiment-service/logs/application.log
```

### 11.2 健康检查端点
- http://localhost:8082/actuator/health (用户服务)
- http://localhost:8083/actuator/health (实验服务)
- http://localhost:8084/actuator/health (资源服务)
- http://localhost:8085/actuator/health (消息服务)
- http://localhost:8086/actuator/health (讨论服务)

## 12. 故障排查

### 12.1 常见问题
1. **服务无法注册到Eureka**: 检查网络连接和Eureka配置
2. **配置获取失败**: 验证配置中心是否正常运行
3. **数据库连接失败**: 检查数据库服务和连接配置
4. **Feign调用失败**: 检查服务发现和负载均衡配置

### 12.2 调试技巧
1. 查看Eureka控制台确认服务注册状态
2. 检查各服务的健康检查端点
3. 分析日志文件定位问题
4. 使用Postman或curl测试API接口

## 测试检查清单

- [ ] 基础设施服务全部启动成功
- [ ] 所有业务服务注册到Eureka
- [ ] 配置中心正常提供配置
- [ ] API网关路由正常工作
- [ ] 各服务单元测试通过
- [ ] Feign客户端调用正常
- [ ] 数据库连接正常
- [ ] 认证和授权正常工作
- [ ] 跨服务业务流程正常
- [ ] 负载均衡正常工作
- [ ] 监控和日志正常

完成以上测试后，您的微服务架构就已经验证完毕，可以正常投入使用了。
